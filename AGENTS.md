# AGENTS.md - pulumi-formal

Guide for humans and agents working on this repository.

## What This Repo Is

This is a **Pulumi provider** for [Formal](https://joinformal.com), bridged from the upstream [Terraform provider](https://github.com/formalco/terraform-provider-formal) using [pulumi-terraform-bridge](https://github.com/pulumi/pulumi-terraform-bridge). It generates SDKs for Python, Node.js, Go, and .NET.

The bridged architecture means we don't write resource implementations directly. Instead, we wrap the upstream Terraform provider and auto-generate Pulumi SDKs from its schema.

## Repository Layout

```
.ci-mgmt.yaml          # Config for Pulumi's CI management tool (regenerates workflows)
.config/mise.toml       # Tool versions (Go, Node, Python, etc.)
Makefile                # Build automation (autogenerated by ci-mgmt)
provider/
  resources.go          # Bridge configuration: maps TF resources to Pulumi
  cmd/
    pulumi-resource-formal/  # Provider binary entry point
    pulumi-tfgen-formal/     # Code generation entry point
upstream/               # Git submodule -> formalco/terraform-provider-formal
sdk/                    # Generated SDKs (dotnet, go, nodejs, python)
examples/               # Example Pulumi programs
.github/
  workflows/            # CI workflows (mostly autogenerated by ci-mgmt)
  actions/esc-action/   # Stub action for secret passthrough (ignore)
```

## Workflow

**All changes should be made in pull requests, not pushed directly to `main`.** The primary CI workflow (`run-acceptance-tests.yml`) triggers on PRs. Push-triggered workflows (`main.yml`, `prerelease.yml`, `release.yml`) only run on `main` and will show spurious failures on feature branches.

## Common Tasks

### Updating the upstream Terraform provider

This is the most frequent maintenance task. When the upstream TF provider releases a new version:

1. **Update the submodule:**
   ```sh
   cd upstream
   git fetch
   git checkout <new-tag-or-commit>
   cd ..
   ```

2. **Update Go dependencies** (the provider imports the TF provider as a Go module):
   ```sh
   cd provider
   go get github.com/formalco/terraform-provider-formal@<version>
   go mod tidy
   cd ..
   ```

3. **Regenerate the schema and SDKs:**
   ```sh
   make tfgen          # Runs pulumi-tfgen-formal to generate schema
   make provider       # Builds the provider binary
   make build_sdks     # Builds all language SDKs
   ```

4. **Commit everything** - the generated SDK files, updated `go.mod`/`go.sum`, schema JSON, and the submodule pointer.

### Updating ci-mgmt (CI workflows)

The CI workflows are **autogenerated** by [pulumi/ci-mgmt](https://github.com/pulumi/ci-mgmt). To regenerate them after editing `.ci-mgmt.yaml`:

```sh
make ci-mgmt
```

**Warning:** This overwrites all workflow files, the Makefile, and other CI infrastructure. Any manual edits to these files will be lost. If you need to customize workflows, you may need to edit them after running `make ci-mgmt` and accept that the next regeneration will overwrite your changes.

### Building locally

```sh
make build              # Build everything (provider + all SDKs)
make provider           # Build just the provider binary
make schema             # Generate just the schema
make build_sdks         # Build all SDKs
make test               # Run example tests (must build first)
make test_provider      # Run provider unit tests
make lint_provider      # Run golangci-lint
```

Tool installation is handled by [mise](https://mise.jdx.dev/). The `Makefile` will run `mise install` automatically. See `.config/mise.toml` for pinned tool versions.

### Cutting a release

To release a new version, tag `main` and push the tag:

```sh
git tag v1.2.0
git push origin v1.2.0
```

That's it. The `release.yml` workflow triggers on semver tags (`v*.*.*`), builds the provider from scratch, runs all tests, and if they pass, automatically:
- Creates a GitHub Release with provider binaries for all platforms
- Publishes Python SDK to PyPI (`pulumi_formal`)
- Publishes Node.js SDK to npm (`@formalco/pulumi`)
- Publishes .NET SDK to NuGet
- Publishes Go SDK via a tagged commit on the `sdk` branch

For prereleases, use a semver prerelease tag (e.g., `v1.2.0-alpha.1`), which triggers `prerelease.yml` instead.

Java SDK publishing is disabled (see `.ci-mgmt.yaml`).

## CI Architecture

### Workflow structure

Caller workflows (`main.yml`, `prerelease.yml`, `release.yml`, `run-acceptance-tests.yml`) invoke reusable workflows (`prerequisites.yml`, `lint.yml`, `license.yml`, `build_provider.yml`, `build_sdk.yml`, `test.yml`, `publish.yml`).

### Known issues and workarounds

- **ci-mgmt breaking changes:** The upstream `pulumi/ci-mgmt` tool introduces changes that assume Pulumi-internal infrastructure (e.g., a GitHub App for `create-github-app-token`). We've removed this dependency and use `secrets.GITHUB_TOKEN` instead. Running `make ci-mgmt` will re-introduce it, so you'll need to re-apply the removal afterward.

- **`golangci-lint` version:** Pinned in `.config/mise.toml`. When Go is upgraded, the lint version may need to be updated to match. See commit `5f28d17` for an example of this.

## Provider Configuration

Key settings in `provider/resources.go`:
- Upstream provider: `github.com/formalco/terraform-provider-formal/formal`
- Token mapping: `tokens.SingleModule("formal_", "index", ...)` (all resources in one module)
- Plugin download: `github://api.github.com/formalco` (GitHub Releases)
- npm package: `@formalco/pulumi`
- PyPI package: `pulumi_formal`
- NuGet namespace: `Formal.Pulumi`

## Repository Secrets

Required GitHub repository secrets (check with `gh secret list`):
- `NPM_TOKEN` - npm publish token
- `NUGET_PUBLISH_KEY` - NuGet publish key
- `PYPI_API_TOKEN` - PyPI publish token
